AWSTemplateFormatVersion: 2010-09-09
Transform: AWS::Serverless-2016-10-31

Metadata:
  AWS::CloudFormation::Interface:
    ParameterGroups:
      - Label: Code Location
        Parameters:
          - CodeBucket
          - CodePrefix
      - Label: EC2
        Parameters:
          - KeyPair
      - Label: Deployment Configuration
        Parameters:
          - Stage
          - DeploymentPreference
      - Label: DNS
        Parameters:
          - DNSDomainName
          - DNSName
          - ValidationDomain
          - HostedZoneID
      - Label: VPC
        Parameters:
          - EnableVPC
      - Label: EC2 Instance
        Parameters:
          - EnableEC2Instance
          - EC2InstanceSize
      - Label: EMR Cluster
        Parameters:
          - EnableEMRCluster
          - EMRRelease
          - EMRMasterInstanceType
          - EMRMasterInstanceCount
          - EMRCoreInstanceType
          - EMRCoreInstanceCount
      - Label: Redshift
        Parameters:
          - EnableRedshift
          - RedshiftNodeType
          - RedshiftNumberOfNodes
      - Label: API Gateway
        Parameters:
          - APIName
    ParameterLabels:
      CodeBucket:
        default: Bucket containing scripts
      CodePrefix:
        default: Prefix for scripts
      KeyPair:
        default: EC2 KeyPair
      Stage:
        default: Stage to deploy
      DeploymentPreference:
        default: CodeDeploy deployment preference
      DNSDomainName:
        default: Domain name in Route53
      DNSName:
        default: Base DNS name for APIs
      ValidationDomain:
        default: Domain name for ACM certificate validation
      EnableVPC:
        default: Creates a VPC
      EnableEC2Instance:
        default: Creates an EC2 instance for Data Pipeline
      EC2InstanceSize:
        default: Type of EC2 instance
      EnableEMRCluster:
        default: Create an EMR cluster for Data Pipeline
      EMRVersion:
        default: EMR release version
      EMRMasterInstanceType:
        default: Type of EMR master instances
      EMRMasterInstanceCount:
        default: Number of EMR master instances
      EMRCoreInstanceType:
        default: Type of EMR core instances
      EMRCoreInstanceCount:
        default: Number of EMR core instances
      EnableRedshift:
        default: Create a Redshift instance
      RedshiftNodeType:
        default: Type of Redshift instance nodes
      RedshiftNumberOfNodes:
        default: Number of Redshift nodes
      APIName:
        default: Displayed name of API gateway

Parameters:
  CodeBucket:
    Type: String
    Description: The S3 bucket user code is stored in.
  CodePrefix:
    Type: String
    Description: The prefix into the S3 bucket code is stored in.
  KeyPair:
    Type: String
    Description: The EC2 KeyPair to use
  Stage:
    Type: String
    Description: The name for a project pipeline stage, such as Staging or Prod, for which resources are provisioned and deployed.
    Default: ''
  DeploymentPreference:
    Type: String
    Description: The CodeDeploy deployment preference for safe Lambda deploys.
    Default: Canary10Percent5Minutes
    AllowedValues:
      - Canary10Percent5Minutes
      - Canary10Percent10Minutes
      - Canary10Percent15Minutes
      - Canary10Percent30Minutes
      - Linear10PercentEvery1Minutes
      - Linear10PercentEvery2Minutes
      - Linear10PercentEvery3Minutes
      - Linear10PercentEvery10Minutes
      - AllAtOnce
  DNSDomainName:
    Type: String
    Description: The domain name in Route53, such as example.com, this warehouse is served from.
    Default: ''
  DNSName:
    Type: String
    Description: The base DNS name, such as warehouse.example.com, this warehouse is served from.  Must be a the DNSDomainName or a subdomain of it.
    Default: ''
  ValidationDomain:
    Type: String
    Description: The DNS domain to validate ACM certificates against, such as example.com.  Should be a the DNSDomainName.
    Default: ''
  HostedZoneID:
    Type: String
    Description: The existing Hosted Zone to use.  Creates a Hosted Zone if not provided.
    Default: ''
  EnableVPC:
    Type: String
    Description: If non-empty, create a VPC.  EnableEC2Instance, EnableEMRCluster, and EnableRedshift imply this option.
    Default: ''
  EnableEC2Instance:
    Type: String
    Description: If non-empty, create an EC2 instance for use by Data Pipeline.
    Default: ''
  EC2InstanceSize:
    Type: String
    Description: The instance size of the EC2 instance for use by Data Pipeline
    Default: t2.nano
  EnableEMRCluster:
    Type: String
    Description: If non-empty, create an EMR cluster.
    Default: ''
  EMRRelease:
    Type: String
    Description: The EMR release version to use.
    Default: emr-5.23.0
  EMRMasterInstanceType:
    Type: String
    Description: The instance type of the master instances in the EMR cluster.
    AllowedPattern: "[\u0020-\uD7FF\uE000-\uFFFD\uD800\uDC00-\uDBFF\uDFFF\r\n\t]*"
    Default: m1.medium
  EMRMasterInstanceCount:
    Type: Number
    Description: The number of master instances in the EMR cluster.
    MinValue: 1
    MaxValue: 256
    Default: 1
  EMRCoreInstanceType:
    Type: String
    Description: The instance type of the core instances in the EMR cluster.
    AllowedPattern: "[\u0020-\uD7FF\uE000-\uFFFD\uD800\uDC00-\uDBFF\uDFFF\r\n\t]*"
    Default: m1.medium
  EMRCoreInstanceCount:
    Type: Number
    Description: The number of core instances in the EMR cluster.
    MinValue: 1
    MaxValue: 256
    Default: 1
  EnableRedshift:
    Type: String
    Description: If non-empty, create a Redshift cluster.
    Default: ''
  RedshiftNodeType:
    Type: String
    Description: The type of instances in the Redshift cluster.
    AllowedValues:
      - dc2.large
      - dc2.8xlarge
      - ds2.xlarge
      - ds2.8xlarge
    Default: dc2.large
  RedshiftNumberOfNodes:
    Type: Number
    Description: The number of nodes in the Redshift cluster.
    MinValue: 1
    MaxValue: 100
    Default: 1
  APIName:
    Type: String
    Description: The name of the API Gateway api.
    Default: Warehouse Service

Conditions:
  DNSEnabled: !And
    - !Not [!Equals [!Ref DNSDomainName, ""]]
    - !Not [!Equals [!Ref DNSName, ""]]
    - !Not [!Equals [!Ref ValidationDomain, ""]]
  InternalHostedZone: !And
    - !Not [!Equals [!Ref DNSDomainName, ""]]
    - !Not [!Equals [!Ref DNSName, ""]]
    - !Not [!Equals [!Ref ValidationDomain, ""]]
    - !Not [!Equals [!Ref HostedZoneID, ""]]
  EC2InstanceEnabled: !Not [!Equals [!Ref EnableEC2Instance, ""]]
  EMREnabled: !Not [!Equals [!Ref EnableEMRCluster, ""]]
  RedshiftEnabled: !Not [!Equals [!Ref EnableRedshift, ""]]
  RedshiftSingleNode: !Equals [!Ref RedshiftNumberOfNodes, 1]
  VPCEnabled: !Or
    - !Not [!Equals [!Ref EnableVPC, ""]]
    - !Not [!Equals [!Ref EnableEC2Instance, ""]]
    - !Not [!Equals [!Ref EnableEMRCluster, ""]]
    - !Not [!Equals [!Ref EnableRedshift, ""]]

Outputs:
  BaseURL:
    Value: !If
      - DNSEnabled
      - !Ref DNSName
      - !Sub "https://${API}.execute-api.${AWS::Region}.${AWS::URLSuffix}/${Stage}"

Mappings:
  AMIs:
    us-east-1:
      PV64Instance: ami-0023040df18933030
    us-west-2:
      PV64Instance: ami-afe1c0d7
    eu-west-1:
      PV64Instance: ami-0c651f40f9861388f
    ap-southeast-2:
      PV64Instance: ami-0d783a243942fbe54
    ap-northeast-1:
      PV64Instance: ami-0f16a2ca7efacfa65

Globals:
  Function:
    Runtime: go1.x
    CodeUri:
      Bucket: !Ref CodeBucket
      Key: !Sub "${CodePrefix}/lambda/lambdas.zip"
    Tracing: Active
    AutoPublishAlias: Live
    DeploymentPreference:
      Enabled: true
      Type: !Ref DeploymentPreference
  Api:
    TracingEnabled: true
    EndpointConfiguration: EDGE
  SimpleTable:
    SSESpecification:
      SSEEnabled: true

Resources:
  ##########
  # Bucket #
  ##########

  Bucket:
    Type: AWS::S3::Bucket
    DeletionPolicy: Retain
    Properties:
      VersioningConfiguration:
        Status: Enabled
      BucketEncryption:
        ServerSideEncryptionConfiguration:
          - ServerSideEncryptionByDefault:
              SSEAlgorithm: aws:kms
      MetricsConfigurations:
        - Id: raw-events
          Prefix: data/raw/events/
        - Id: events
          Prefix: data/lake/events/
        - Id: advertising
          Prefix: data/lake/advertising/

  #######
  # VPC #
  #######

  VPC:
    Type: AWS::EC2::VPC
    Condition: VPCEnabled
    Properties:
      CidrBlock: 172.31.0.0/16
      EnableDnsSupport: true
      EnableDnsHostnames: true
      InstanceTenancy: default

  InternetGateway:
    Type: AWS::EC2::InternetGateway
    Condition: VPCEnabled
    DependsOn:
      - VPC

  GatewayAttachment:
    Type: AWS::EC2::VPCGatewayAttachment
    Condition: VPCEnabled
    Properties:
      VpcId: !Ref VPC
      InternetGatewayId: !Ref InternetGateway

  Subnet:
    Type: AWS::EC2::Subnet
    Condition: VPCEnabled
    Properties:
      VpcId: !Ref VPC
      AvailabilityZone: !Select
        - 0
        - Fn::GetAZs: !Ref AWS::Region
      CidrBlock: 172.31.0.0/16
      MapPublicIpOnLaunch: true

  RouteTable:
    Type: AWS::EC2::RouteTable
    Condition: VPCEnabled
    Properties:
      VpcId: !Ref VPC

  Route:
    Type: AWS::EC2::Route
    Condition: VPCEnabled
    DependsOn:
      - GatewayAttachment
    Properties:
      DestinationCidrBlock: 0.0.0.0/0
      GatewayId: !Ref InternetGateway
      RouteTableId: !Ref RouteTable

  Association:
    Type: AWS::EC2::SubnetRouteTableAssociation
    Condition: VPCEnabled
    Properties:
      RouteTableId: !Ref RouteTable
      SubnetId: !Ref Subnet

  SecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Condition: VPCEnabled
    Properties:
      GroupName: SecurityGroup
      GroupDescription: Default Security Group
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 0
          ToPort: 65535
          CidrIp: 0.0.0.0/0
        - IpProtocol: udp
          FromPort: 0
          ToPort: 65535
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 8443
          ToPort: 8443
          CidrIp: 0.0.0.0/0
      SecurityGroupEgress:
        - IpProtocol: -1
          CidrIp: 0.0.0.0/0

  ############
  # Redshift #
  ############

  RedshiftClusterSecurityGroup:
    Type: AWS::Redshift::ClusterSecurityGroup
    Condition: RedshiftEnabled
    Properties:
      Description: Redshift Cluster Security Group

  RedshiftClusterSecurityGroupIngress:
    Type: AWS::Redshift::ClusterSecurityGroupIngress
    Condition: RedshiftEnabled
    Properties:
      ClusterSecurityGroupName: !Ref RedshiftClusterSecurityGroup
      CIDRIP: 0.0.0.0/0

  RedshiftClusterSubnetGroup:
    Type: AWS::Redshift::ClusterSubnetGroup
    Condition: RedshiftEnabled
    Properties:
      Description: Redshift Cluster Subnet Group
      SubnetIds:
        - !Ref Subnet

  RedshiftRole:
    Type: AWS::IAM::Role
    Condition: RedshiftEnabled
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
              - sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - !Sub "redshift.${AWS::URLSuffix}"
      Policies:
        - PolicyName: Spectrum
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Action:
                  - s3:Get*
                  - s3:List*
                Effect: Allow
                Resource:
                  - !Sub "${Bucket.Arn}/data/lake/events/*"
                  - !Sub "${Bucket.Arn}/data/lake/advertising/*"

  Redshift:
    Type: AWS::Redshift::Cluster
    Condition: RedshiftEnabled
    Properties: !If
      - RedshiftSingleNode
      - ClusterType: single-node
        ClusterIdentifier: !Sub "${AWS::StackName}-${AWS::Region}-redshift-cluster"
        DBName: "warehouse"
        Encrypted: true
        MasterUsername: "warehouse"
        MasterUserPassword: "War340u5e!"
        NodeType: !Ref RedshiftNodeType
        ClusterSubnetGroupName: !Ref RedshiftClusterSubnetGroup
        VpcSecurityGroupIds:
          - !Ref SecurityGroup
          - !GetAtt VPC.DefaultSecurityGroup
        IamRoles:
          - !GetAtt RedshiftRole.Arn
        PubliclyAccessible: true
        AvailabilityZone: !GetAtt Subnet.AvailabilityZone
      - ClusterType: multi-node
        ClusterIdentifier: !Sub "${AWS::StackName}-${AWS::Region}-redshift-cluster"
        DBName: "warehouse"
        Encrypted: true
        MasterUsername: "warehouse"
        MasterUserPassword: "War340u5e!"
        NodeType: !Ref RedshiftNodeType
        NumberOfNodes: !Ref RedshiftNumberOfNodes
        ClusterSubnetGroupName: !Ref RedshiftClusterSubnetGroup
        VpcSecurityGroupIds:
          - !Ref SecurityGroup
          - !GetAtt VPC.DefaultSecurityGroup
        IamRoles:
          - !GetAtt RedshiftRole.Arn
        PubliclyAccessible: true
        AvailabilityZone: !GetAtt Subnet.AvailabilityZone

  ############
  # Instance #
  ############

  InstanceRole:
    Type: AWS::IAM::Role
    Condition: EC2InstanceEnabled
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
              - sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - !Sub "ec2.${AWS::URLSuffix}"
                - !Sub "elasticmapreduce.${AWS::URLSuffix}"
                - !Sub "iam.${AWS::URLSuffix}"
                - !Sub "s3.${AWS::URLSuffix}"
                - !Sub "sqs.${AWS::URLSuffix}"
                - !Sub "logs.${AWS::Region}.${AWS::URLSuffix}"
                - !Sub "autoscaling.${AWS::URLSuffix}"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforDataPipelineRole

  InstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Condition: EC2InstanceEnabled
    Properties:
      Roles:
        - !Ref InstanceRole

  Instance:
    Type: AWS::EC2::Instance
    Condition: EC2InstanceEnabled
    Properties:
      IamInstanceProfile: !Ref InstanceProfile
      ImageId: !FindInMap
        - AMIs
        - !Ref AWS::Region
        - PV64Instance
      SecurityGroupIds:
        - !Ref SecurityGroup
        - !GetAtt VPC.DefaultSecurityGroup
      SubnetId: !Ref Subnet
      UserData:
        Fn::Base64:
          !Sub |
            #!/bin/bash
            set -x -e

            # Install task runner
            aws s3 cp "s3://datapipeline-us-east-1/us-east-1/software/latest/TaskRunner/TaskRunner-1.0.jar" "${!HOME}/TaskRunner-1.0.jar"
            nohup java -jar "${!HOME}/TaskRunner-1.0.jar" --workerGroup="${AWS::StackName}-${AWS::Region}-instance-worker-group" --region="${AWS::Region}" --logUri="s3://${Bucket}/logs/task-runner/instance/" &

  #######
  # EMR #
  #######

  EMRJobFlowRole:
    Type: AWS::IAM::Role
    Condition: EMREnabled
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
              - sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - !Sub "ec2.${AWS::URLSuffix}"
                - !Sub "elasticmapreduce.${AWS::URLSuffix}"
                - !Sub "iam.${AWS::URLSuffix}"
                - !Sub "s3.${AWS::URLSuffix}"
                - !Sub "sqs.${AWS::URLSuffix}"
                - !Sub "logs.${AWS::Region}.${AWS::URLSuffix}"
                - !Sub "autoscaling.${AWS::URLSuffix}"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonElasticMapReduceforEC2Role
        - arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforDataPipelineRole
      Policies:
        - PolicyName: JobFlow
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Action:
                  - cloudwatch:*
                  - dynamodb:*
                  - ec2:Describe*
                  - elasticmapreduce:Describe*
                  - elasticmapreduce:ListBootstrapActions
                  - elasticmapreduce:ListClusters
                  - elasticmapreduce:ListInstanceGroups
                  - elasticmapreduce:ListInstances
                  - elasticmapreduce:ListSteps
                  - kinesis:CreateStream
                  - kinesis:DeleteStream
                  - kinesis:DescribeStream
                  - kinesis:GetRecords
                  - kinesis:GetShardIterator
                  - kinesis:MergeShards
                  - kinesis:PutRecord
                  - kinesis:SplitShard
                  - rds:Describe*
                  - s3:*
                  - sdb:*
                  - sns:*
                  - sqs:*
                  - glue:CreateDatabase
                  - glue:UpdateDatabase
                  - glue:DeleteDatabase
                  - glue:GetDatabase
                  - glue:GetDatabases
                  - glue:CreateTable
                  - glue:UpdateTable
                  - glue:DeleteTable
                  - glue:GetTable
                  - glue:GetTables
                  - glue:GetTableVersions
                  - glue:CreatePartition
                  - glue:BatchCreatePartition
                  - glue:UpdatePartition
                  - glue:DeletePartition
                  - glue:BatchDeletePartition
                  - glue:GetPartition
                  - glue:GetPartitions
                  - glue:BatchGetPartition
                  - glue:CreateUserDefinedFunction
                  - glue:UpdateUserDefinedFunction
                  - glue:DeleteUserDefinedFunction
                  - glue:GetUserDefinedFunction
                  - glue:GetUserDefinedFunctions
                Effect: Allow
                Resource: "*"
              - Action:
                  - cloudwatch:*
                  - datapipeline:*
                  - dynamodb:*
                  - ec2:Describe*
                  - elasticmapreduce:AddJobFlowSteps
                  - elasticmapreduce:Describe*
                  - elasticmapreduce:ListInstance*
                  - rds:Describe*
                  - redshift:DescribeClusters
                  - redshift:DescribeClusterSecurityGroups
                  - s3:*
                  - sdb:*
                  - sns:*
                  - sqs:*
                Effect: Allow
                Resource: "*"

  EMRProfile:
    Type: AWS::IAM::InstanceProfile
    Condition: EMREnabled
    Properties:
      Roles:
        - !Ref EMRJobFlowRole

  EMRServiceRole:
    Type: AWS::IAM::Role
    Condition: EMREnabled
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
              - sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - !Sub "ec2.${AWS::URLSuffix}"
                - !Sub "elasticmapreduce.${AWS::URLSuffix}"
                - !Sub "iam.${AWS::URLSuffix}"
                - !Sub "s3.${AWS::URLSuffix}"
                - !Sub "sqs.${AWS::URLSuffix}"
                - !Sub "logs.${AWS::Region}.${AWS::URLSuffix}"
                - !Sub "autoscaling.${AWS::URLSuffix}"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonElasticMapReduceRole
      Policies:
        - PolicyName: Service
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Action:
                  - ec2:AuthorizeSecurityGroupEgress
                  - ec2:AuthorizeSecurityGroupIngress
                  - ec2:CancelSpotInstanceRequests
                  - ec2:CreateNetworkInterface
                  - ec2:CreateSecurityGroup
                  - ec2:CreateTags
                  - ec2:DeleteNetworkInterface
                  - ec2:DeleteSecurityGroup
                  - ec2:DeleteTags
                  - ec2:DescribeAvailabilityZones
                  - ec2:DescribeAccountAttributes
                  - ec2:DescribeDhcpOptions
                  - ec2:DescribeImages
                  - ec2:DescribeInstanceStatus
                  - ec2:DescribeInstances
                  - ec2:DescribeKeyPairs
                  - ec2:DescribeNetworkAcls
                  - ec2:DescribeNetworkInterfaces
                  - ec2:DescribePrefixLists
                  - ec2:DescribeRouteTables
                  - ec2:DescribeSecurityGroups
                  - ec2:DescribeSpotInstanceRequests
                  - ec2:DescribeSpotPriceHistory
                  - ec2:DescribeSubnets
                  - ec2:DescribeTags
                  - ec2:DescribeVpcAttribute
                  - ec2:DescribeVpcEndpoints
                  - ec2:DescribeVpcEndpointServices
                  - ec2:DescribeVpcs
                  - ec2:DetachNetworkInterface
                  - ec2:ModifyImageAttribute
                  - ec2:ModifyInstanceAttribute
                  - ec2:RequestSpotInstances
                  - ec2:RevokeSecurityGroupEgress
                  - ec2:RunInstances
                  - ec2:TerminateInstances
                  - ec2:DeleteVolume
                  - ec2:DescribeVolumeStatus
                  - ec2:DescribeVolumes
                  - ec2:DetachVolume
                  - iam:GetRole
                  - iam:GetRolePolicy
                  - iam:ListInstanceProfiles
                  - iam:ListRolePolicies
                  - iam:PassRole
                  - s3:CreateBucket
                  - s3:Get*
                  - s3:List*
                  - sdb:BatchPutAttributes
                  - sdb:Select
                  - sqs:CreateQueue
                  - sqs:Delete*
                  - sqs:GetQueue*
                  - sqs:PurgeQueue
                  - sqs:ReceiveMessage
                  - cloudwatch:PutMetricAlarm
                  - cloudwatch:DescribeAlarms
                  - cloudwatch:DeleteAlarms
                  - application-autoscaling:RegisterScalableTarget
                  - application-autoscaling:DeregisterScalableTarget
                  - application-autoscaling:PutScalingPolicy
                  - application-autoscaling:DeleteScalingPolicy
                  - application-autoscaling:Describe*
                Effect: Allow
                Resource: "*"

  EMR:
    Type: AWS::EMR::Cluster
    Condition: EMREnabled
    Properties:
      Applications:
        - Name: hive
        - Name: pig
        - Name: spark
      # BootstrapActions:
      #   - Name: Install Task Runner
      #     ScriptBootstrapAction:
      #       Path: s3://elasticmapreduce/bootstrap-actions/run-if
      #       Args:
      #         - instance.isMaster=true
      #         - !Sub "s3://${CodeBucket}/${CodePrefix}/scripts/emr/install_task_runner.sh"
      #         - !Sub "${AWS::StackName}-${AWS::Region}-emr-worker-group"
      #         - !Ref AWS::Region
      #         - !Sub "s3://${Bucket}/logs/task-runner/emr/"
      Configurations:
        - Classification: hive-site
          ConfigurationProperties:
            hive.metastore.client.factory.class: com.amazonaws.glue.catalog.metastore.AWSGlueDataCatalogHiveClientFactory
            hive.metastore.glue.catalogid: !Ref AWS::AccountId
        - Classification: spark-hive-site
          ConfigurationProperties:
            hive.metastore.client.factory.class: com.amazonaws.glue.catalog.metastore.AWSGlueDataCatalogHiveClientFactory
            hive.metastore.glue.catalogid: !Ref AWS::AccountId
      Instances:
        AdditionalMasterSecurityGroups:
          - !Ref SecurityGroup
          - !GetAtt VPC.DefaultSecurityGroup
        AdditionalSlaveSecurityGroups:
          - !Ref SecurityGroup
          - !GetAtt VPC.DefaultSecurityGroup
        Ec2KeyName: !Ref KeyPair
        Ec2SubnetId: !Ref Subnet
        MasterInstanceGroup:
          InstanceCount: !Ref EMRMasterInstanceCount
          InstanceType: !Ref EMRMasterInstanceType
        CoreInstanceGroup:
          InstanceCount: !Ref EMRCoreInstanceCount
          InstanceType: !Ref EMRCoreInstanceType
        TerminationProtected: false
      JobFlowRole: !Ref EMRProfile
      Name: !Sub "${AWS::StackName}-${AWS::Region}-warehouse-emr-cluster"
      ReleaseLabel: !Ref EMRRelease
      ServiceRole: !Ref EMRServiceRole
      LogUri: !Sub "s3://${Bucket}/logs/emr"

  ####################
  # Delivery Streams #
  ####################

  DeliveryStreamRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
              - sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - !Sub "firehose.${AWS::URLSuffix}"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSGlueServiceRole
      Policies:
        - PolicyName: Execution
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Action:
                  - s3:PutObject*
                Effect: Allow
                Resource:
                  - !Sub "${Bucket.Arn}/data/raw/events/*"

  EventsDeliveryStream:
    Type: AWS::KinesisFirehose::DeliveryStream
    Properties:
      DeliveryStreamType: DirectPut
      S3DestinationConfiguration:
        BucketARN: !GetAtt Bucket.Arn
        Prefix: data/raw/events/
        BufferingHints:
          IntervalInSeconds: 900
          SizeInMBs: 128
        CompressionFormat: GZIP
        RoleARN: !GetAtt DeliveryStreamRole.Arn

  EventsDeliveryStreamRecordsPerSecondAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      Statistic: Average
      Namespace: "AWS/Firehose"
      MetricName: IncomingRecords
      Dimensions:
        - Name: DeliveryStreamName
          Value: !Ref EventsDeliveryStream
      ComparisonOperator: GreaterThanThreshold
      Threshold: 4000
      DatapointsToAlarm: 3
      EvaluationPeriods: 5
      Period: 60

  EventsDeliveryStreamTransactionsPerSecondAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      Statistic: Average
      Namespace: "AWS/Firehose"
      MetricName: PutRecordBatch.Requests
      Dimensions:
        - Name: DeliveryStreamName
          Value: !Ref EventsDeliveryStream
      ComparisonOperator: GreaterThanThreshold
      Threshold: 1600
      DatapointsToAlarm: 3
      EvaluationPeriods: 5
      Period: 60

  EventsDeliveryStreamDataThroughputAlarm:
    Type: AWS::CloudWatch::Alarm
    Properties:
      Statistic: Average
      Namespace: "AWS/Firehose"
      MetricName: IncomingBytes
      Dimensions:
        - Name: DeliveryStreamName
          Value: !Ref EventsDeliveryStream
      ComparisonOperator: GreaterThanThreshold
      Threshold: 4194304
      DatapointsToAlarm: 3
      EvaluationPeriods: 5
      Period: 60

  #############
  # Real Time #
  #############

  RealTimeAdvertisingDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardBody: !Sub |
        {
          "start": "-PT1H",
          "periodOverride": "inherit",
          "widgets": [
            {
              "type": "text",
              "width": 24,
              "height": 1,
              "properties": {
                "markdown": "# Clickthrough Rate"
              }
            },
            {
              "type": "metric",
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [],
                "period": 300,
                "stat": "Average",
                "region": "${AWS::Region}",
                "title": "Clickthrough Rate"
              }
            }
          ]
        }

  RealTimeAdvertisingLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - !Sub "lambda.${AWS::URLSuffix}"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
        - arn:aws:iam::aws:policy/AWSXrayWriteOnlyAccess

  RealTimeAdvertisingLambda:
    Type: AWS::Serverless::Function
    Properties:
      Handler: bin/real-time-advertising
      Role: !GetAtt RealTimeAdvertisingLambdaRole.Arn

  RealTimeAdvertisingApplicationRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
              - sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - !Sub "kinesisanalytics.${AWS::URLSuffix}"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonKinesisAnalyticsFullAccess
      Policies:
        - PolicyName: Execution
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Action:
                  - lambda:InvokeFunction
                  - lambda:GetFunctionConfiguration
                Effect: Allow
                Resource:
                  - !GetAtt RealTimeAdvertisingLambda.Arn
              - Action:
                  - firehose:DescribeDeliveryStream
                  - firehose:Get*
                Effect: Allow
                Resource:
                  - !GetAtt EventsDeliveryStream.Arn

  RealTimeAdvertisingApplication:
    Type: AWS::KinesisAnalytics::Application
    Properties:
      ApplicationCode: |
        CREATE OR REPLACE STREAM "impressions" (
          "session_id"    VARCHAR(64),
          "context_id"    VARCHAR(64),
          "event_id"      VARCHAR(64),
          "ad_id"         VARCHAR(64),
          "impression_at" TIMESTAMP
        );

        CREATE OR REPLACE PUMP "impressions_pump" AS
        INSERT INTO "impressions"
        SELECT STREAM
          "events"."session_id"  AS "session_id",
          "events"."context_id"  AS "context_id",
          "events"."event_id"    AS "event_id",
          "events"."object_id"   AS "ad_id",
          "events"."occurred_at" AS "impression_at"
        FROM
          "events_001" AS "events"
        WHERE
              "events"."object_type" = 'ad'
          AND "events"."event_type" = 'impression'
        ;

        CREATE OR REPLACE STREAM "clicks" (
          "session_id" VARCHAR(64),
          "context_id" VARCHAR(64),
          "parent_id"  VARCHAR(64),
          "ad_id"      VARCHAR(64),
          "click_at"   TIMESTAMP
        );

        CREATE OR REPLACE PUMP "clicks_pump" AS
        INSERT INTO "clicks"
        SELECT STREAM
          "events"."session_id"  AS "session_id",
          "events"."context_id"  AS "context_id",
          "events"."parent_id"   AS "parent_id",
          "events"."object_id"   AS "ad_id",
          "events"."occurred_at" AS "click_at"
        FROM
          "events_001" AS "events"
        WHERE
              "events"."object_type" = 'ad'
          AND "events"."event_type" = 'click'
        ;

        CREATE OR REPLACE STREAM "advertising" (
          "ad_id"         VARCHAR(64),
          "impression_at" TIMESTAMP,
          "click_at"      TIMESTAMP
        );

        CREATE OR REPLACE PUMP "advertising_pump" AS
        INSERT INTO "advertising"
        SELECT STREAM
          "impressions"."ad_id"         AS "ad_id",
          "impressions"."impression_at" AS "impression_at",
          "clicks"."click_at"           AS "click_at"
        FROM "impressions" OVER "last_5_minutes"
        LEFT OUTER JOIN "clicks" OVER "last_5_minutes"
          ON  "impressions"."session_id" = "clicks"."session_id"
          AND "impressions"."context_id" = "clicks"."context_id"
          AND "impressions"."event_id"   = "clicks"."parent_id"
        WINDOW
          "last_5_minutes" AS (RANGE INTERVAL '5' MINUTE PRECEDING)
        ;
      Inputs:
        - NamePrefix: events
          KinesisFirehoseInput:
            ResourceARN: !GetAtt EventsDeliveryStream.Arn
            RoleARN: !GetAtt RealTimeAdvertisingApplicationRole.Arn
          InputSchema:
            RecordEncoding: UTF-8
            RecordFormat:
              RecordFormatType: JSON
              MappingParameters:
                JSONMappingParameters:
                  RecordRowPath: "$"
            RecordColumns:
              - Name: session_id
                SqlType: VARCHAR(64)
                Mapping: "$.session_id"
              - Name: context_id
                SqlType: VARCHAR(64)
                Mapping: "$.context_id"
              - Name: parent_id
                SqlType: VARCHAR(64)
                Mapping: "$.parent_id"
              - Name: actor_type
                SqlType: VARCHAR(255)
                Mapping: "$.actor_type"
              - Name: actor_id
                SqlType: VARCHAR(64)
                Mapping: "$.actor_id"
              - Name: event_type
                SqlType: VARCHAR(255)
                Mapping: "$.event_type"
              - Name: event_id
                SqlType: VARCHAR(64)
                Mapping: "$.event_id"
              - Name: object_type
                SqlType: VARCHAR(255)
                Mapping: "$.object_type"
              - Name: object_id
                SqlType: VARCHAR(64)
                Mapping: "$.object_id"
              - Name: occurred_at
                SqlType: TIMESTAMP
                Mapping: "$.occurred_at"

  RealTimeEventsOutputs:
    Type: AWS::KinesisAnalytics::ApplicationOutput
    Properties:
      ApplicationName: !Ref RealTimeAdvertisingApplication
      Output:
        Name: advertising
        DestinationSchema:
          RecordFormatType: JSON
        LambdaOutput:
          ResourceARN: !GetAtt RealTimeAdvertisingLambda.Arn
          RoleARN: !GetAtt RealTimeAdvertisingApplicationRole.Arn

  #############
  # Data Lake #
  #############

  Database:
    Type: AWS::Glue::Database
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseInput:
        Name: warehouse

  CrawlerRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
              - sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - !Sub "glue.${AWS::URLSuffix}"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSGlueServiceRole
      Policies:
        - PolicyName: Execution
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Action:
                  - s3:GetObject*
                  - s3:PutObject*
                Effect: Allow
                Resource:
                  - !Sub "${Bucket.Arn}/data/raw/events/*"
              - Action:
                  - s3:ListBucket*
                Effect: Allow
                Resource:
                  - !GetAtt Bucket.Arn

  RawEventsCrawler:
    Type: AWS::Glue::Crawler
    Properties:
      Name: raw_events_crawler
      Description: Crawls the raw event data
      Role: !GetAtt CrawlerRole.Arn
      DatabaseName: !Ref Database
      Targets: # CloudFormation does not seem to support targeting an existing table.  Console does, at least.
        S3Targets:
          - Path: !Sub "s3://${Bucket}/data/raw/events/"
      TablePrefix: raw_
      SchemaChangePolicy:
        UpdateBehavior: UPDATE_IN_DATABASE
        DeleteBehavior: LOG
      Schedule:
        ScheduleExpression: cron(20 * * * ? *)
      Configuration: |
        {
          "Version": 1.0,
          "Grouping": {
            "TableGroupingPolicy": "CombineCompatibleSchemas"
          },
          "CrawlerOutput": {
            "Partitions": {
              "AddOrUpdateBehavior": "InheritFromTable"
            },
            "Tables": {
              "AddOrUpdateBehavior": "MergeNewColumns"
            }
          }
        }

  EventsTable:
    Type: AWS::Glue::Table
    DependsOn:
      - Database
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref Database
      TableInput:
          Name: events
          Description: Events
          TableType: EXTERNAL_TABLE
          Parameters:
            classification: orc
          PartitionKeys:
            - Name: year
              Type: int
            - Name: month
              Type: int
          StorageDescriptor:
            Location: !Sub "s3://${Bucket}/data/lake/events/"
            StoredAsSubDirectories: true
            InputFormat: org.apache.hadoop.hive.ql.io.orc.OrcInputFormat
            SerdeInfo:
              SerializationLibrary: org.apache.hadoop.hive.ql.io.orc.OrcSerde
            OutputFormat: org.apache.hadoop.hive.ql.io.orc.OrcOutputFormat
            Columns:
              - Name: session_id
                Type: string
              - Name: context_id
                Type: string
              - Name: parent_id
                Type: string
              - Name: actor_type
                Type: string
              - Name: actor_id
                Type: string
              - Name: event_type
                Type: string
              - Name: event_id
                Type: string
              - Name: object_type
                Type: string
              - Name: object_id
                Type: string
              - Name: occurred_at
                Type: timestamp

  ETLJobRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
            - sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - !Sub "glue.${AWS::URLSuffix}"
      Policies:
        - PolicyName: "root"
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Action: "*"
                Effect: Allow
                Resource: "*"

  EventsPythonETLJob:
    Type: AWS::Glue::Job
    Properties:
      Role: !GetAtt ETLJobRole.Arn
      Command:
        Name: glueetl
        ScriptLocation: !Sub "s3://${CodeBucket}/${CodePrefix}/scripts/glue/events_etl.py"
      DefaultArguments:
        "--enable-glue-datacatalog": ""
        "--job-bookmark-option": "job-bookmark-enable"
        "--database_name": !Ref Database
        "--raw_table_name": raw_events # Hard-coded because CloudFormation-based Crawlers can't crawl an existing table
        "--table_name": !Ref EventsTable
      ExecutionProperty:
        MaxConcurrentRuns: 1
      MaxRetries: 0

  EventsScalaETLJob:
    Type: AWS::Glue::Job
    Properties:
      Role: !GetAtt ETLJobRole.Arn
      Command:
        Name: glueetl
        ScriptLocation: !Sub "s3://${CodeBucket}/${CodePrefix}/scripts/glue/events_etl.scala"
      DefaultArguments:
        "--job-language": scala
        "--class": GlueApp
        "--enable-glue-datacatalog": ""
        "--job-bookmark-option": "job-bookmark-enable"
        "--database_name": !Ref Database
        "--raw_table_name": raw_events # Hard-coded because CloudFormation-based Crawlers can't crawl an existing table
        "--table_name": !Ref EventsTable
      ExecutionProperty:
        MaxConcurrentRuns: 1
      MaxRetries: 0

  #########
  # Batch #
  #########

  AdvertisingTable:
    Type: AWS::Glue::Table
    DependsOn:
      - Database
    Properties:
      CatalogId: !Ref AWS::AccountId
      DatabaseName: !Ref Database
      TableInput:
          Name: advertising
          Description: Online Advertising
          TableType: EXTERNAL_TABLE
          Parameters:
            classification: orc
          PartitionKeys:
            - Name: year
              Type: int
            - Name: month
              Type: int
          StorageDescriptor:
            Location: !Sub "s3://${Bucket}/data/lake/advertising/"
            StoredAsSubDirectories: true
            InputFormat: org.apache.hadoop.hive.ql.io.orc.OrcInputFormat
            SerdeInfo:
              SerializationLibrary: org.apache.hadoop.hive.ql.io.orc.OrcSerde
            OutputFormat: org.apache.hadoop.hive.ql.io.orc.OrcOutputFormat
            Columns:
              - Name: session_id
                Type: string
              - Name: user_id
                Type: string
              - Name: ad_id
                Type: string
              - Name: impression_at
                Type: timestamp
              - Name: click_at
                Type: timestamp

  AdvertisingInfoTable:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: ad_id
          AttributeType: S
        - AttributeName: day
          AttributeType: S
      KeySchema:
        - AttributeName: ad_id
          KeyType: HASH
        - AttributeName: day
          KeyType: RANGE
      BillingMode: PAY_PER_REQUEST
      SSESpecification:
        SSEEnabled: true

  PipelineRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
              - sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - !Sub "logs.${AWS::Region}.${AWS::URLSuffix}"
                - !Sub "datapipeline.${AWS::URLSuffix}"
                - !Sub "dynamodb.${AWS::URLSuffix}"
                - !Sub "ec2.${AWS::URLSuffix}"
                - !Sub "elasticmapreduce.${AWS::URLSuffix}"
                - !Sub "iam.${AWS::URLSuffix}"
                - !Sub "rds.${AWS::URLSuffix}"
                - !Sub "redshift.${AWS::URLSuffix}"
                - !Sub "s3.${AWS::URLSuffix}"
                - !Sub "sns.${AWS::URLSuffix}"
                - !Sub "sqs.${AWS::URLSuffix}"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSDataPipelineRole
      Policies:
        - PolicyName: GlueAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Action:
                  - glue:*
                Effect: Allow
                Resource: "*"

  PipelineProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: !Ref PipelineRole
      Roles:
        - !Ref PipelineRole

  PipelineResourceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
              - sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - !Sub "logs.${AWS::Region}.${AWS::URLSuffix}"
                - !Sub "datapipeline.${AWS::URLSuffix}"
                - !Sub "dynamodb.${AWS::URLSuffix}"
                - !Sub "ec2.${AWS::URLSuffix}"
                - !Sub "elasticmapreduce.${AWS::URLSuffix}"
                - !Sub "iam.${AWS::URLSuffix}"
                - !Sub "rds.${AWS::URLSuffix}"
                - !Sub "redshift.${AWS::URLSuffix}"
                - !Sub "s3.${AWS::URLSuffix}"
                - !Sub "sns.${AWS::URLSuffix}"
                - !Sub "sqs.${AWS::URLSuffix}"
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AmazonEC2RoleforDataPipelineRole
      Policies:
        - PolicyName: GlueAccess
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Action:
                  - glue:*
                Effect: Allow
                Resource: "*"

  PipelineResourceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      InstanceProfileName: !Ref PipelineResourceRole
      Roles:
        - !Ref PipelineResourceRole

  EMRPipeline:
    Type: AWS::DataPipeline::Pipeline
    DependsOn:
      - PipelineProfile
      - PipelineResourceProfile
    Properties:
      Name: EMR Pipeline
      Activate: false
      ParameterObjects:
        - Id: myRegion
          Attributes:
            - Key: type
              StringValue: String
            - Key: default
              StringValue: !Ref AWS::Region
      ParameterValues:
        - Id: myRegion
          StringValue: !Ref AWS::Region
      PipelineObjects:
        - Id: DailySchedule
          Name: Daily Schedule
          Fields:
            - Key: type
              StringValue: Schedule
            - Key: period
              StringValue: 1 days
            - Key: startDateTime
              StringValue: "2019-05-21T00:00:00"
            - Key: occurrences
              StringValue: 1
        - Id: Default
          Name: Default
          Fields:
            - Key: type
              StringValue: Default
            - Key: schedule
              RefValue: DailySchedule
            - Key: scheduleType
              StringValue: timeseries
            - Key: role
              StringValue: !Ref PipelineRole
            - Key: resourceRole
              StringValue: !Ref PipelineResourceRole
            - Key: pipelineLogUri
              StringValue: !Sub "s3://${Bucket}/logs/data-pipeline/"
            - Key: failureAndRerunMode
              StringValue: cascade
        - Id: HiveMetastoreClientFactoryClass
          Name: Hive Metastore Client Factory Class
          Fields:
            - Key: type
              StringValue: Property
            - Key: key
              StringValue: hive.metastore.client.factory.class
            - Key: value
              StringValue: com.amazonaws.glue.catalog.metastore.AWSGlueDataCatalogHiveClientFactory
        - Id: HiveMetastoreCatalog
          Name: Hive Metastore Catalog
          Fields:
            - Key: type
              StringValue: Property
            - Key: key
              StringValue: hive.metastore.glue.catalogid
            - Key: value
              StringValue: !Ref AWS::AccountId
        - Id: GlueCatalogAsHiveMetastore
          Name: Glue Catalog as Hive Metastore
          Fields:
            - Key: type
              StringValue: EmrConfiguration
            - Key: classification
              StringValue: hive-site
            - Key: property
              RefValue: HiveMetastoreClientFactoryClass
            - Key: property
              RefValue: HiveMetastoreCatalog
        - Id: GlueCatalogAsSparkMetastore
          Name: Glue Catalog as Spark Metastore
          Fields:
            - Key: type
              StringValue: EmrConfiguration
            - Key: classification
              StringValue: spark-hive-site
            - Key: property
              RefValue: HiveMetastoreClientFactoryClass
            - Key: property
              RefValue: HiveMetastoreCatalog
        - Id: EMRCluster
          Name: EMR Cluster
          Fields:
            - Key: type
              StringValue: EmrCluster
            - Key: keyPair
              StringValue: !Ref KeyPair
            - Key: masterInstanceType
              StringValue: !Ref EMRMasterInstanceType
            - Key: coreInstanceType
              StringValue: !Ref EMRCoreInstanceType
            - Key: coreInstanceCount
              StringValue: 10
            - Key: releaseLabel
              StringValue: !Ref EMRRelease
            - Key: applications
              StringValue: hive
            - Key: applications
              StringValue: pig
            - Key: applications
              StringValue: spark
            - Key: terminateAfter
              StringValue: 1 hours
            - Key: configuration
              RefValue: GlueCatalogAsHiveMetastore
            - Key: configuration
              RefValue: GlueCatalogAsSparkMetastore
        - Id: ExtractAdvertisingData
          Name: Extract Advertising Data
          Fields:
            - Key: type
              StringValue: HiveActivity
            - Key: scriptUri
              StringValue: !Sub "s3://${CodeBucket}/${CodePrefix}/scripts/hive/extract_advertising_data.hql"
            - !If
                - EMREnabled
                - Key: workerGroup
                  StringValue: !Sub "${AWS::StackName}-${AWS::Region}-emr-worker-group"
                - Key: runsOn
                  RefValue: EMRCluster
            - Key: stage
              StringValue: false
            - Key: scriptVariable
              StringValue: PARTITION_YEAR=#{year(@scheduledStartTime)}
            - Key: scriptVariable
              StringValue: PARTITION_MONTH=#{month(@scheduledStartTime)}
            - Key: scriptVariable
              StringValue: TIME_START=#{format(@scheduledStartTime, 'YYYY-MM-dd HH:mm:ss')}
            - Key: scriptVariable
              StringValue: TIME_END=#{format(@scheduledEndTime, 'YYYY-MM-dd HH:mm:ss')}
        - Id: AdvertisingInfoTableExists
          Name: Advertising Info Table Exists
          Fields:
            - Key: type
              StringValue: DynamoDBTableExists
            - Key: tableName
              StringValue: !Ref AdvertisingInfoTable
        - Id: AdvertisingInfoStagingTableFormat
          Name: Advertising Info Staging Table Format
          Fields:
            - Key: type
              StringValue: DynamoDBExportDataFormat
            - Key: column
              StringValue: ad_id STRING
            - Key: column
              StringValue: day STRING
            - Key: column
              StringValue: impressions BIGINT
            - Key: column
              StringValue: clicks BIGINT
            - Key: column
              StringValue: clickthrough_rate DOUBLE
        - Id: AdvertisingInfoStagingTable
          Name: Advertising Info Staging Table
          Fields:
            - Key: type
              StringValue: S3DataNode
            - Key: directoryPath
              StringValue: !Sub "s3://${Bucket}/data/tmp/advertising-info-staging-table/"
            - Key: dataFormat
              RefValue: AdvertisingInfoStagingTableFormat
        - Id: AdvertisingInfoTableFormat
          Name: Advertising Info Table Format
          Fields:
            - Key: type
              StringValue: DynamoDBExportDataFormat
        - Id: AdvertisingInfoTable
          Name: Advertising Info Table
          Fields:
            - Key: type
              StringValue: DynamoDBDataNode
            - Key: tableName
              StringValue: !Ref AdvertisingInfoTable
            - Key: dataFormat
              RefValue: AdvertisingInfoTableFormat
            - Key: precondition
              RefValue: AdvertisingInfoTableExists
        - Id: StageDataForAdvertisingInfo
          Name: Stage Data for Advertising Info
          Fields:
            - Key: type
              StringValue: HiveActivity
            - Key: dependsOn
              RefValue: ExtractAdvertisingData
            - Key: scriptUri
              StringValue: !Sub "s3://${CodeBucket}/${CodePrefix}/scripts/hive/stage_data_for_advertising_info.hql"
            - !If
                - EMREnabled
                - Key: workerGroup
                  StringValue: !Sub "${AWS::StackName}-${AWS::Region}-emr-worker-group"
                - Key: runsOn
                  RefValue: EMRCluster
            - Key: input
              RefValue: AdvertisingInfoStagingTable
            - Key: output
              RefValue: AdvertisingInfoStagingTable
            - Key: scriptVariable
              StringValue: PARTITION_YEAR=#{year(@scheduledStartTime)}
            - Key: scriptVariable
              StringValue: PARTITION_MONTH=#{month(@scheduledStartTime)}
            - Key: scriptVariable
              StringValue: TIME_START=#{format(@scheduledStartTime, 'YYYY-MM-dd HH:mm:ss')}
            - Key: scriptVariable
              StringValue: TIME_END=#{format(@scheduledEndTime, 'YYYY-MM-dd HH:mm:ss')}
        - Id: LoadAdvertisingInfoTable
          Name: Load Advertising Info Into DynamoDB Table
          Fields:
            - Key: type
              StringValue: HiveCopyActivity
            - Key: dependsOn
              RefValue: StageDataForAdvertisingInfo
            - Key: input
              RefValue: AdvertisingInfoStagingTable
            - Key: output
              RefValue: AdvertisingInfoTable
            - !If
                - EMREnabled
                - Key: workerGroup
                  StringValue: !Sub "${AWS::StackName}-${AWS::Region}-emr-worker-group"
                - Key: runsOn
                  RefValue: EMRCluster
        - Id: TruncateAdvertisingInfoStagingTable
          Name: Truncate Advertising Info Staging Table
          Fields:
            - Key: type
              StringValue: HiveActivity
            - Key: dependsOn
              RefValue: LoadAdvertisingInfoTable
            - Key: hiveScript
              StringValue: TRUNCATE TABLE ${input1}
            - !If
                - EMREnabled
                - Key: workerGroup
                  StringValue: !Sub "${AWS::StackName}-${AWS::Region}-emr-worker-group"
                - Key: runsOn
                  RefValue: EMRCluster
            - Key: input
              RefValue: AdvertisingInfoStagingTable
            - Key: output
              RefValue: AdvertisingInfoStagingTable

  RedshiftPipeline:
    Type: AWS::DataPipeline::Pipeline
    Condition: RedshiftEnabled
    DependsOn:
      - PipelineProfile
      - PipelineResourceProfile
    Properties:
      Name: Redshift Pipeline
      Activate: false
      ParameterObjects:
        - Id: myRegion
          Attributes:
            - Key: type
              StringValue: String
            - Key: default
              StringValue: !Ref AWS::Region
      ParameterValues:
        - Id: myRegion
          StringValue: !Ref AWS::Region
      PipelineObjects:
        - Id: DailySchedule
          Name: Daily Schedule
          Fields:
            - Key: type
              StringValue: Schedule
            - Key: period
              StringValue: 1 days
            - Key: startDateTime
              StringValue: "2019-05-21T00:00:00"
            - Key: occurrences
              StringValue: 1
        - Id: Default
          Name: Default
          Fields:
            - Key: type
              StringValue: Default
            - Key: schedule
              RefValue: DailySchedule
            - Key: scheduleType
              StringValue: timeseries
            - Key: role
              StringValue: !Ref PipelineRole
            - Key: resourceRole
              StringValue: !Ref PipelineResourceRole
            - Key: pipelineLogUri
              StringValue: !Sub "s3://${Bucket}/logs/data-pipeline/"
            - Key: failureAndRerunMode
              StringValue: cascade
        - Id: EC2Instance
          Name: EC2 Instance
          Fields:
            - Key: type
              StringValue: Ec2Resource
            - Key: actionOnTaskFailure
              StringValue: terminate
            - Key: actionOnResourceFailure
              StringValue: retryAll
            - Key: maximumRetries
              StringValue: 1
            - Key: instanceType
              StringValue: m1.medium
            - Key: subnetId
              StringValue: !Ref Subnet
            - Key: securityGroupIds
              StringValue: !Ref SecurityGroup
            - Key: associatePublicIpAddress
              StringValue: true
            - Key: keyPair
              StringValue: !Ref KeyPair
            - Key: terminateAfter
              StringValue: 1 hours
        - Id: HiveMetastoreClientFactoryClass
          Name: Hive Metastore Client Factory Class
          Fields:
            - Key: type
              StringValue: Property
            - Key: key
              StringValue: hive.metastore.client.factory.class
            - Key: value
              StringValue: com.amazonaws.glue.catalog.metastore.AWSGlueDataCatalogHiveClientFactory
        - Id: HiveMetastoreCatalog
          Name: Hive Metastore Catalog
          Fields:
            - Key: type
              StringValue: Property
            - Key: key
              StringValue: hive.metastore.glue.catalogid
            - Key: value
              StringValue: !Ref AWS::AccountId
        - Id: GlueCatalogAsHiveMetastore
          Name: Glue Catalog as Hive Metastore
          Fields:
            - Key: type
              StringValue: EmrConfiguration
            - Key: classification
              StringValue: hive-site
            - Key: property
              RefValue: HiveMetastoreClientFactoryClass
            - Key: property
              RefValue: HiveMetastoreCatalog
        - Id: GlueCatalogAsSparkMetastore
          Name: Glue Catalog as Spark Metastore
          Fields:
            - Key: type
              StringValue: EmrConfiguration
            - Key: classification
              StringValue: spark-hive-site
            - Key: property
              RefValue: HiveMetastoreClientFactoryClass
            - Key: property
              RefValue: HiveMetastoreCatalog
        - Id: EMRCluster
          Name: EMR Cluster
          Fields:
            - Key: type
              StringValue: EmrCluster
            - Key: keyPair
              StringValue: !Ref KeyPair
            - Key: masterInstanceType
              StringValue: !Ref EMRMasterInstanceType
            - Key: coreInstanceType
              StringValue: !Ref EMRCoreInstanceType
            - Key: coreInstanceCount
              StringValue: 10
            - Key: releaseLabel
              StringValue: !Ref EMRRelease
            - Key: applications
              StringValue: hive
            - Key: applications
              StringValue: pig
            - Key: applications
              StringValue: spark
            - Key: terminateAfter
              StringValue: 1 hours
            - Key: configuration
              RefValue: GlueCatalogAsHiveMetastore
            - Key: configuration
              RefValue: GlueCatalogAsSparkMetastore
        - Id: RedshiftCluster
          Name: Redshift Cluster
          Fields:
            - Key: type
              StringValue: RedshiftDatabase
            - Key: clusterId
              StringValue: !Ref Redshift
            - Key: username
              StringValue: warehouse
            - Key: "*password"
              StringValue: "War340u5e!"
            - Key: databaseName
              StringValue: warehouse
            - Key: region
              StringValue: !Ref AWS::Region
        - Id: RedshiftAdvertisingAdTable
          Name: Redshift Advertising by Ad Table
          Fields:
            - Key: type
              StringValue: RedshiftDataNode
            - Key: database
              RefValue: RedshiftCluster
            - Key: tableName
              StringValue: advertising
            - Key: createTableSql
              StringValue: |
                CREATE TABLE advertising_ad (
                  session_id    VARCHAR(64) NOT NULL,
                  user_id       VARCHAR(64) NOT NULL,
                  ad_id         VARCHAR(64) NOT NULL,
                  impression_at TIMESTAMP   NOT NULL,
                  click_at      TIMESTAMP
                )
                PRIMARY KEY (session_id, user_id, ad_id, impression_at)
                DISTSTYLE KEY
                DISTKEY (ad_id)
                ;
        - Id: RedshiftAdvertisingUserTable
          Name: Redshift Advertising by User Table
          Fields:
            - Key: type
              StringValue: RedshiftDataNode
            - Key: database
              RefValue: RedshiftCluster
            - Key: tableName
              StringValue: advertising
            - Key: createTableSql
              StringValue: |
                CREATE TABLE advertising_user (
                  session_id    VARCHAR(64) NOT NULL,
                  user_id       VARCHAR(64) NOT NULL,
                  ad_id         VARCHAR(64) NOT NULL,
                  impression_at TIMESTAMP   NOT NULL,
                  click_at      TIMESTAMP
                )
                PRIMARY KEY (session_id, user_id, ad_id, impression_at)
                DISTSTYLE KEY
                DISTKEY (user_id)
                ;
        - Id: RedshiftStagingTableFormat
          Name: Redshift Staging Table Format
          Fields:
            - Key: type
              StringValue: CSV
            - Key: column
              StringValue: session_id STRING
            - Key: column
              StringValue: user_id STRING
            - Key: column
              StringValue: ad_id STRING
            - Key: column
              StringValue: impression_at TIMESTAMP
            - Key: column
              StringValue: click_at TIMESTAMP
        - Id: RedshiftStagingTable
          Name: Redshift Staging Table
          Fields:
            - Key: type
              StringValue: S3DataNode
            - Key: directoryPath
              StringValue: !Sub "s3://${Bucket}/data/temp/#{@pipelineId}/#{@version}/#{@scheduledStartTime}/redshift-staging-table/"
            - Key: dataFormat
              RefValue: RedshiftStagingTableFormat
        - Id: StageDataForRedshift
          Name: Stage Data for Redshift
          Fields:
            - Key: type
              StringValue: HiveActivity
            - Key: scriptUri
              StringValue: !Sub "s3://${CodeBucket}/${CodePrefix}/scripts/hive/stage_data_for_redshift.hql"
            - !If
                - EMREnabled
                - Key: workerGroup
                  StringValue: !Sub "${AWS::StackName}-${AWS::Region}-emr-worker-group"
                - Key: runsOn
                  RefValue: EMRCluster
            - Key: input
              StringValue: RedshiftStagingTable
            - Key: output
              RefValue: RedshiftStagingTable
            - Key: scriptVariable
              StringValue: PARTITION_YEAR=#{year(@scheduledStartTime)}
            - Key: scriptVariable
              StringValue: PARTITION_MONTH=#{month(@scheduledStartTime)}
            - Key: scriptVariable
              StringValue: TIME_START=#{format(@scheduledStartTime, 'YYYY-MM-dd HH:mm:ss')}
            - Key: scriptVariable
              StringValue: TIME_END=#{format(@scheduledEndTime, 'YYYY-MM-dd HH:mm:ss')}
        - Id: LoadAdvertisingAdIntoRedshift
          Name: Load Advertising by Ad Into Redshift
          Fields:
            - Key: type
              StringValue: RedshiftCopyActivity
            - Key: dependsOn
              RefValue: StageDataForRedshift
            - Key: input
              RefValue: RedshiftStagingTable
            - Key: output
              RefValue: RedshiftAdvertisingAdTable
            - Key: insertMode
              StringValue: OVERWRITE_EXISTING
            - !If
              - EC2InstanceEnabled
              - Key: workerGroup
                StringValue: !Sub "${AWS::StackName}-${AWS::Region}-instance-worker-group"
              - Key: runsOn
                RefValue: EC2Instance
        - Id: LoadAdvertisingUserIntoRedshift
          Name: Load Advertising by User Into Redshift
          Fields:
            - Key: type
              StringValue: RedshiftCopyActivity
            - Key: dependsOn
              RefValue: StageDataForRedshift
            - Key: input
              RefValue: RedshiftStagingTable
            - Key: output
              RefValue: RedshiftAdvertisingUserTable
            - Key: insertMode
              StringValue: OVERWRITE_EXISTING
            - !If
              - EC2InstanceEnabled
              - Key: workerGroup
                StringValue: !Sub "${AWS::StackName}-${AWS::Region}-instance-worker-group"
              - Key: runsOn
                RefValue: EC2Instance
        - Id: TruncateRedshiftStagingTable
          Name: Truncate Redshift Staging Table
          Fields:
            - Key: type
              StringValue: HiveActivity
            - Key: dependsOn
              RefValue: LoadAdvertisingAdIntoRedshift
            - Key: dependsOn
              RefValue: LoadAdvertisingUserIntoRedshift
            - Key: hiveScript
              StringValue: TRUNCATE TABLE ${input1}
            - !If
                - EMREnabled
                - Key: workerGroup
                  StringValue: !Sub "${AWS::StackName}-${AWS::Region}-emr-worker-group"
                - Key: runsOn
                  RefValue: EMRCluster
            - Key: stage
              StringValue: false
            - Key: input
              RefValue: RedshiftStagingTable
        - Id: UseSpectrumDataLake
          Name: Use Spectrum Data Lake
          Fields:
            - Key: type
              StringValue: SqlActivity
            - !If
              - EC2InstanceEnabled
              - Key: workerGroup
                StringValue: !Sub "${AWS::StackName}-${AWS::Region}-instance-worker-group"
              - Key: runsOn
                RefValue: EC2Instance
            - Key: database
              RefValue: RedshiftCluster
            - Key: scriptUri
              StringValue: !Sub "s3://${CodeBucket}/${CodePrefix}/scripts/redshift/use_spectrum_data_lake.sql"
        - Id: SpectrumLoadAdvertisingAd
          Name: Spectrum Load Advertising by Ad
          Fields:
            - Key: type
              StringValue: SqlActivity
            - Key: database
              RefValue: RedshiftCluster
            - !If
              - EC2InstanceEnabled
              - Key: workerGroup
                StringValue: !Sub "${AWS::StackName}-${AWS::Region}-instance-worker-group"
              - Key: runsOn
                RefValue: EC2Instance
            - Key: scriptUri
              StringValue: !Sub "s3://${CodeBucket}/${CodePrefix}/scripts/redshift/load_advertising_ad_from_spectrum.sql"
        - Id: SpectrumLoadAdvertisingUser
          Name: Spectrum Load Advertising by User
          Fields:
            - Key: type
              StringValue: SqlActivity
            - Key: database
              RefValue: RedshiftCluster
            - !If
              - EC2InstanceEnabled
              - Key: workerGroup
                StringValue: !Sub "${AWS::StackName}-${AWS::Region}-instance-worker-group"
              - Key: runsOn
                RefValue: EC2Instance
            - Key: scriptUri
              StringValue: !Sub "s3://${CodeBucket}/${CodePrefix}/scripts/redshift/load_advertising_user_from_spectrum.sql"

  #######
  # API #
  #######

  APIRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action:
              - sts:AssumeRole
            Effect: Allow
            Principal:
              Service:
                - !Sub "apigateway.${AWS::URLSuffix}"
      Policies:
        - PolicyName: Execution
          PolicyDocument:
            Version: "2012-10-17"
            Statement:
              - Action:
                  - firehose:PutRecordBatch
                Effect: Allow
                Resource:
                  - !GetAtt EventsDeliveryStream.Arn
              - Action:
                  - dynamodb:Query
                Effect: Allow
                Resource:
                  - !GetAtt AdvertisingInfoTable.Arn

  API:
    Type: AWS::Serverless::Api
    Properties:
      StageName: !Ref Stage
      MethodSettings:
        - HttpMethod: "*"
          ResourcePath: "/*"
          # LoggingLevel: "ERROR"
          MetricsEnabled: true
      TracingEnabled: true
      DefinitionBody:
        openapi: 3.0.0
        info:
          version: 0.1.0
          title: !Ref APIName
        paths:
          /data/events:
            post:
              summary: Record a batch of events
              operationId: data-events
              requestBody:
                description: A batch of ad events
                required: true
                content:
                  application/json:
                    schema:
                      $ref: "#/components/schemas/DataEvents"
              x-amazon-apigateway-integration:
                type: AWS
                httpMethod: POST
                uri: !Sub "arn:aws:apigateway:${AWS::Region}:firehose:action/PutRecordBatch"
                credentials: !GetAtt APIRole.Arn
                requestTemplates:
                  application/json: !Sub |
                    #set($newline = "
                    ")
                    {
                      "DeliveryStreamName": "${EventsDeliveryStream}",
                      "Records": [
                        #foreach($elem in $input.path('$.events'))
                        #set($val = $input.json("$.events[$foreach.index]"))
                        #set($rec = "${!val}${!newline}")
                        { "Data": "$util.base64Encode($rec)" }#if($foreach.hasNext),#end
                        #end
                      ]
                    }
                requestParameters:
                  integration.request.header.Content-Type: "'x-amz-json-1.1'"
                responses:
                  '200':
                    statusCode: 200
                    responseTemplates:
                      application/json: |
                        {
                          "failed_count": $input.path("$.FailedPutCount"),
                          "records": [
                            #foreach($record in $input.path("$.RequestResponses"))
                            {
                              #if($record.keySet().contains("ErrorCode"))
                              "failed": true,
                              "error_code": "$record.ErrorCode",
                              "error_message": "$record.ErrorMessage"
                              #else
                              "failed": false
                              #end
                            }#if($foreach.hasNext),#end
                            #end
                          ]
                        }
              responses:
                '200':
                  description: |
                    The batch was processed.  Some events may not have been
                    processed.  The response contains a list of events in the
                    same order submitted, indicating which succeeded and which
                    failed.
                  content:
                    application/json:
                      schema:
                        $ref: "#/components/schemas/BatchWriteResponse"
          /info/events:
            get:
              summary: Get info about events
              operationId: info-events
              x-amazon-apigateway-integration:
                type: AWS
                httpMethod: POST
                uri: !Sub "arn:aws:apigateway:${AWS::Region}:dynamodb:action/Query"
                credentials: !GetAtt APIRole.Arn
                requestTemplates:
                  application/json: !Sub |
                    {
                      #if($input.params('page') != "")
                      "ExclusiveStartKey": $util.parseJSON($util.base64Decode($input.params('page'))),
                      #end
                      "ExpressionAttributeNames": {
                        "#ID": "ID",
                        "#Date": "Date"
                      },
                      "ExpressionAttributeValues": {
                        ":id": { "S": "$input.params('id')" },
                        ":start": { "S": "$input.params('start')" },
                        ":end": { "S": #if($input.params('end') != "") "$input.params('end')" #else "$input.params('start')" #end }
                      },
                      "KeyConditionExpression": "#ID = :id AND #Date BETWEEN #start AND #end",
                      "Limit": $input.params('limit'),
                      "TableName": "${AdvertisingInfoTable}"
                    }
                requestParameters:
                  integration.request.header.Content-Type: "'x-amz-json-1.1'"
                responses:
                  '200':
                    statusCode: 200
                    responseTemplates:
                      application/json: |
                        {
                          #if($input.path('$.LastEvaluatedKey') != "")
                          "next": "$util.base64Encode($input.json('$.LastEvaluatedKey'))",
                          #end
                          "count": $input.path('$.Count'),
                          "events": [
                            #foreach($elem in $input.path('$.Items'))
                            {
                              "id": "$elem.ID"
                            }#if($foreach.hasNext),#end
                            #end
                          ]
                        }
              responses:
                '200':
                  description: |
                    The query was successful.
                  content:
                    application/json:
                      schema:
                        $ref: "#/components/schemas/EventsInfo"
        x-amazon-apigateway-request-validators:
          all:
            validateRequestBody: true
            validateRequestParameters: true
        x-amazon-apigateway-request-validator: all
        components:
          schemas:
            DataEvents:
              type: object
              properties:
                events:
                  type: array
                  items:
                    $ref: "#/components/schemas/DataEvent"
                  minItems: 1
                  maxItems: 500
              required:
                - events
              additionalProperties: false
            DataEvent:
              type: object
              properties:
                session_id:
                  type: string
                  format: uuid
                context_id:
                  type: string
                  format: uuid
                parent_id:
                  type: string
                  format: uuid
                actor_type:
                  type:
                    $ref: "#/components/schemas/Type"
                actor_id:
                  type: string
                  format: uuid
                event_type:
                  type:
                    $ref: "#/components/schemas/Type"
                event_id:
                  type: string
                  format: uuid
                object_type:
                  type:
                    $ref: "#/components/schemas/Type"
                object_id:
                  type: string
                  format: uuid
                occurred_at:
                  type:
                    $ref: "#/components/schemas/Timestamp"
              required:
                - session_id
                - context_id
                - actor_type
                - actor_id
                - event_type
                - event_id
                - object_type
                - object_id
                - occurred_at
              additionalProperties: false
            BatchWriteResponse:
              type: object
              properties:
                records:
                  type: array
                  items:
                    $ref: "#/components/schemas/BatchWriteRecord"
                  minItems: 1
                  maxItems: 500
              required:
                - records
              additionalProperties: false
            BatchWriteRecord:
              type: object
              properties:
                failed:
                  type: boolean
                error_code:
                  type: string
                error_message:
                  type: string
              required:
                - failed
              additionalProperties: false
            EventsInfo:
              type: object
              properties:
                next:
                  type:
                    $ref: "#/components/schemas/Base64"
                count:
                  type: integer
                  minimum: 0
                events:
                  type: array
                  items:
                    $ref: "#/components/schemas/EventInfo"
              required:
                - count
                - events
              additionalProperties: false
            EventInfo:
              type: object
              properties:
                id:
                  type: string
                  format: uuid
              required:
                - id
              additionalProperties: false
            Error:
              type: object
              properties:
                code:
                  type: integer
                  format: int32
                message:
                  type: string
              required:
                - code
                - message
              additionalProperties: false
            Type:
              type: string
              format: "^[a-z]+[-a-z0-9]*$"
            Date:
              type: string
              format: "^[0-9]{4}-[0-9]{2}-[0-9]{2}$"
            Timestamp:
              type: string
              format: "^[0-9]{4}-[0-9]{2}-[0-9]{2} [0-9]{2}:[0-9]{2}:[0-9]{2}(\\.[0-9]{3})?$"
            Base64:
              type: string
              format: "^(?:[A-Za-z0-9+/]{4})*(?:[A-Za-z0-9+/]{2}==|[A-Za-z0-9+/]{3}=)?$"

  Certificate:
    Type: AWS::CertificateManager::Certificate
    Condition: DNSEnabled
    Properties:
      DomainName: !Ref DNSName
      DomainValidationOptions:
        - DomainName: !Ref DNSName
          ValidationDomain: !Ref ValidationDomain

  DomainName:
    Type: AWS::ApiGateway::DomainName
    Condition: DNSEnabled
    Properties:
      CertificateArn: !Ref Certificate
      DomainName: !Ref DNSName

  BasePathMapping:
    Type: AWS::ApiGateway::BasePathMapping
    Condition: DNSEnabled
    Properties:
      DomainName: !Ref DomainName
      RestApiId: !Ref API
      Stage: !Ref API.Stage

  #######
  # DNS #
  #######

  HostedZone:
    Type: AWS::Route53::HostedZone
    Condition: InternalHostedZone
    Properties:
      Name: !Ref DNSDomainName

  RecordSetGroup:
    Type: AWS::Route53::RecordSetGroup
    Condition: DNSEnabled
    Properties:
      HostedZoneId: !If [InternalHostedZone, !Ref HostedZone, !Ref HostedZoneID]
      RecordSets:
        - Type: A
          Name: !Ref DNSName
          AliasTarget:
            DNSName: !GetAtt DomainName.DistributionDomainName
            HostedZoneId: Z2FDTNDATAQYW2

  #################
  # Ops Dashboard #
  #################

  OpsDashboard:
    Type: AWS::CloudWatch::Dashboard
    Properties:
      DashboardBody: !Sub |
        {
          "start": "-PT1H",
          "periodOverride": "inherit",
          "widgets": [
            {
              "type": "text",
              "width": 24,
              "height": 1,
              "properties": { "markdown": "# Beacon Endpoints" }
            },
            {
              "type": "metric",
              "width": 6,
              "height": 4,
              "properties": {
                "metrics": [
                  ["AWS/ApiGateway", "Count", "ApiName", "${APIName}", "Resource", "/data/events", "Method", "POST", "Stage", "${Stage}"]
                ],
                "period": 60,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Request Rate",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 6,
              "height": 4,
              "properties": {
                "metrics": [
                  ["AWS/ApiGateway", "Latency", "ApiName", "${APIName}", "Resource", "/data/events", "Method", "POST", "Stage", "${Stage}"]
                ],
                "period": 60,
                "stat": "p95",
                "region": "${AWS::Region}",
                "title": "Latency",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 6,
              "height": 4,
              "properties": {
                "metrics": [
                  ["AWS/ApiGateway", "IntegrationLatency", "ApiName", "${APIName}", "Resource", "/data/events", "Method", "POST", "Stage", "${Stage}"]
                ],
                "period": 60,
                "stat": "p95",
                "region": "${AWS::Region}",
                "title": "Integration Latency",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 6,
              "height": 4,
              "properties": {
                "metrics": [
                  ["AWS/ApiGateway", "4XXError", "ApiName", "${APIName}", "Resource", "/data/events", "Method", "POST", "Stage", "${Stage}"],
                  [".",              "5XXError", ".",       "${APIName}", ".",        "/data/events", ".",      "POST", ".",     "${Stage}"]
                ],
                "period": 60,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Errors",
                "liveData": false
              }
            },
            {
              "type": "text",
              "width": 24,
              "height": 1,
              "properties": { "markdown": "# Firehoses" }
            },
            {
              "type": "metric",
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/Firehose", "IncomingRecords", "DeliveryStreamName", "${EventsDeliveryStream}"]
                ],
                "period": 60,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Incoming Records",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/Firehose", "IncomingBytes", "DeliveryStreamName", "${EventsDeliveryStream}"]
                ],
                "period": 60,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Incoming Bytes",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/Firehose", "DeliveryToS3.Success", "DeliveryStreamName", "${EventsDeliveryStream}"]
                ],
                "period": 60,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Successful Delivery To S3",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/Firehose", "DeliveryToS3.Records", "DeliveryStreamName", "${EventsDeliveryStream}"]
                ],
                "period": 60,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Records Delivered To S3",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/Firehose", "DeliveryToS3.Bytes", "DeliveryStreamName", "${EventsDeliveryStream}"]
                ],
                "period": 60,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Bytes Delivered To S3",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/Firehose", "DeliveryToS3.DataFreshness", "DeliveryStreamName", "${EventsDeliveryStream}"]
                ],
                "period": 60,
                "stat": "Maximum",
                "region": "${AWS::Region}",
                "title": "Delivery To S3 Data Freshness",
                "liveData": false
              }
            },
            {
              "type": "text",
              "width": 24,
              "height": 1,
              "properties": { "markdown": "# Real-Time App" }
            },
            {
              "type": "metric",
              "width": 24,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/KinesisAnalytics", "Success", "Application", "${RealTimeAdvertisingApplication}"]
                ],
                "period": 60,
                "region": "${AWS::Region}",
                "title": "Success",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 6,
              "height": 4,
              "properties": {
                "metrics": [
                  ["AWS/KinesisAnalytics", "KPUs", "Application", "${RealTimeAdvertisingApplication}"]
                ],
                "period": 60,
                "stat": "Average",
                "region": "${AWS::Region}",
                "title": "KPUs",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 6,
              "height": 4,
              "properties": {
                "metrics": [
                  ["AWS/KinesisAnalytics", "MillisBehindLatest", "Application", "${RealTimeAdvertisingApplication}"]
                ],
                "period": 60,
                "stat": "Maximum",
                "region": "${AWS::Region}",
                "title": "Lag (ms)",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 6,
              "height": 4,
              "properties": {
                "metrics": [
                  ["AWS/KinesisAnalytics", "Records", "Application", "${RealTimeAdvertisingApplication}"]
                ],
                "period": 60,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Records Processed",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 6,
              "height": 4,
              "properties": {
                "metrics": [
                  ["AWS/KinesisAnalytics", "Bytes", "Application", "${RealTimeAdvertisingApplication}"]
                ],
                "period": 60,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Bytes Processed",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/KinesisAnalytics", "InputProcessing.Success", "Application", "${RealTimeAdvertisingApplication}"]
                ],
                "period": 60,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Input Processing Success",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/KinesisAnalytics", "InputProcessing.OkBytes", "Application", "${RealTimeAdvertisingApplication}"]
                ],
                "period": 60,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Input Processing Bytes",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/KinesisAnalytics", "InputProcessing.Duration", "Application", "${RealTimeAdvertisingApplication}"]
                ],
                "period": 60,
                "stat": "Average",
                "region": "${AWS::Region}",
                "title": "Input Processing Duration",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/KinesisAnalytics", "InputProcessing.OkRecords", "Application", "${RealTimeAdvertisingApplication}"]
                ],
                "period": 60,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Input Processing Successful Records",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/KinesisAnalytics", "InputProcessing.DroppedRecords", "Application", "${RealTimeAdvertisingApplication}"]
                ],
                "period": 60,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Input Processing Dropped Records",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/KinesisAnalytics", "InputProcessing.ProcessingFailedRecords", "Application", "${RealTimeAdvertisingApplication}"]
                ],
                "period": 60,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Input Processing Failed Records",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/KinesisAnalytics", "LambdaDelivery.OkRecords", "Application", "${RealTimeAdvertisingApplication}"]
                ],
                "period": 60,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Lambda Delivery Success",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/KinesisAnalytics", "LambdaDelivery.DeliveryFailedRecords", "Application", "${RealTimeAdvertisingApplication}"]
                ],
                "period": 60,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Lambda Delivery Failures",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 8,
              "height": 6,
              "properties": {
                "metrics": [
                  ["AWS/KinesisAnalytics", "LambdaDelivery.Duration", "Application", "${RealTimeAdvertisingApplication}"]
                ],
                "period": 60,
                "stat": "Average",
                "region": "${AWS::Region}",
                "title": "Lambda Delivery Duration",
                "liveData": false
              }
            },
            {
              "type": "text",
              "width": 24,
              "height": 1,
              "properties": { "markdown": "# Lambas" }
            },
            {
              "type": "metric",
              "width": 6,
              "height": 4,
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Invocations", "FunctionName", "${RealTimeAdvertisingLambda}"]
                ],
                "period": 60,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Invocations",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 6,
              "height": 4,
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Duration", "FunctionName", "${RealTimeAdvertisingLambda}"]
                ],
                "period": 60,
                "stat": "p95",
                "region": "${AWS::Region}",
                "title": "Duration",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 6,
              "height": 4,
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Errors", "FunctionName", "${RealTimeAdvertisingLambda}"]
                ],
                "period": 60,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Errors",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 6,
              "height": 4,
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "DeadLetterErrors", "FunctionName", "${RealTimeAdvertisingLambda}"]
                ],
                "period": 60,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Dead Letter Errors",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 6,
              "height": 4,
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "ConcurrentExecutions", "FunctionName", "${RealTimeAdvertisingLambda}"]
                ],
                "period": 60,
                "stat": "Maximum",
                "region": "${AWS::Region}",
                "title": "Concurrent Executions",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 6,
              "height": 4,
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "UnreservedConcurrentExecutions", "FunctionName", "${RealTimeAdvertisingLambda}"]
                ],
                "period": 60,
                "stat": "Average",
                "region": "${AWS::Region}",
                "title": "Unreserved Concurrent Executions",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 6,
              "height": 4,
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "Throttles", "FunctionName", "${RealTimeAdvertisingLambda}"]
                ],
                "period": 60,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Throttles",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 6,
              "height": 4,
              "properties": {
                "metrics": [
                  ["AWS/Lambda", "IteratorAge", "FunctionName", "${RealTimeAdvertisingLambda}"]
                ],
                "period": 60,
                "stat": "Maximum",
                "region": "${AWS::Region}",
                "title": "Iterator Age",
                "liveData": false
              }
            },
            {
              "type": "text",
              "width": 24,
              "height": 1,
              "properties": { "markdown": "# Data Lake" }
            },
            {
              "type": "metric",
              "width": 12,
              "height": 4,
              "properties": {
                "metrics": [
                  ["AWS/S3", "BucketSizeBytes", "StorageType", "AllStorageTypes"]
                ],
                "period": 86400,
                "stat": "Maximum",
                "region": "${AWS::Region}",
                "title": "Bucket Size (bytes)",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 12,
              "height": 4,
              "properties": {
                "metrics": [
                  ["AWS/S3", "NumberOfObject", "StorageType", "AllStorageTypes"]
                ],
                "period": 86400,
                "stat": "Maximum",
                "region": "${AWS::Region}",
                "title": "Bucket Size (objects)",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 6,
              "height": 4,
              "properties": {
                "metrics": [
                  ["AWS/S3", "AllRequests", "BucketName", "${Bucket}", "FilterId", "raw-events"],
                  ["AWS/S3", "AllRequests", "BucketName", "${Bucket}", "FilterId", "events"]
                ],
                "period": 60,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "All Requests",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 6,
              "height": 4,
              "properties": {
                "metrics": [
                  ["AWS/S3", "GetRequests", "BucketName", "${Bucket}", "FilterId", "raw-events"],
                  ["AWS/S3", "GetRequests", "BucketName", "${Bucket}", "FilterId", "events"]
                ],
                "period": 60,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Get Requests",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 6,
              "height": 4,
              "properties": {
                "metrics": [
                  ["AWS/S3", "PutRequests", "BucketName", "${Bucket}", "FilterId", "raw-events"],
                  ["AWS/S3", "PutRequests", "BucketName", "${Bucket}", "FilterId", "events"]
                ],
                "period": 60,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Put Requests",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 6,
              "height": 4,
              "properties": {
                "metrics": [
                  ["AWS/S3", "SelectRequests", "BucketName", "${Bucket}", "FilterId", "raw-events"],
                  ["AWS/S3", "SelectRequests", "BucketName", "${Bucket}", "FilterId", "events"]
                ],
                "period": 60,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Select Requests",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 6,
              "height": 4,
              "properties": {
                "metrics": [
                  ["AWS/S3", "BytesUploaded", "BucketName", "${Bucket}", "FilterId", "raw-events"],
                  ["AWS/S3", "BytesUploaded", "BucketName", "${Bucket}", "FilterId", "events"]
                ],
                "period": 60,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Bytes Uploaded",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 6,
              "height": 4,
              "properties": {
                "metrics": [
                  ["AWS/S3", "BytesDownloaded", "BucketName", "${Bucket}", "FilterId", "raw-events"],
                  ["AWS/S3", "BytesDownloaded", "BucketName", "${Bucket}", "FilterId", "events"]
                ],
                "period": 60,
                "stat": "Sum",
                "region": "${AWS::Region}",
                "title": "Get Requests",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 6,
              "height": 4,
              "properties": {
                "metrics": [
                  ["AWS/S3", "FirstByteLatency", "BucketName", "${Bucket}", "FilterId", "raw-events"],
                  ["AWS/S3", "FirstByteLatency", "BucketName", "${Bucket}", "FilterId", "events"]
                ],
                "period": 60,
                "stat": "p95",
                "region": "${AWS::Region}",
                "title": "Put Requests",
                "liveData": false
              }
            },
            {
              "type": "metric",
              "width": 6,
              "height": 4,
              "properties": {
                "metrics": [
                  ["AWS/S3", "TotalRequestLatency", "BucketName", "${Bucket}", "FilterId", "raw-events"],
                  ["AWS/S3", "TotalRequestLatency", "BucketName", "${Bucket}", "FilterId", "events"]
                ],
                "period": 60,
                "stat": "p95",
                "region": "${AWS::Region}",
                "title": "Select Requests",
                "liveData": false
              }
            },
            {
              "type": "text",
              "width": 24,
              "height": 1,
              "properties": { "markdown": "# Athena" }
            },
            {
              "type": "text",
              "width": 24,
              "height": 1,
              "properties": { "markdown": "# Glue ETL Jobs" }
            }
          ]
        }
